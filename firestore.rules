rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    function isOwner(userId) {
      return request.auth.uid == userId;
    }

    function isSignedIn() {
      return request.auth != null;
    }

    // Server has all access
    function isServer() {
      return request.auth == null;
    }

    match /users/{userId} {
      // Read: Any signed-in user can read another user's profile and played games list
      allow read: if isSignedIn();

      // Write: You can only write to your own document, OR if the server is making the request,
      // OR if you are the host of a game room and are updating the xp.
      allow create: if isOwner(userId);
      allow update: if isOwner(userId) || isServer() || (
        get(/databases/$(database)/documents/game-rooms/$(request.resource.data.gameRoomId)).data.hostId == request.auth.uid
      );

      match /playedGameSets/{playedGameSetId} {
        allow read: if isSignedIn();
        allow write: if isOwner(userId) || (
          // Allow host to write to playedGameSets of players in their room
          exists(/databases/$(database)/documents/game-rooms/$(request.resource.data.gameRoomId)) &&
          get(/databases/$(database)/documents/game-rooms/$(request.resource.data.gameRoomId)).data.hostId == request.auth.uid
        );
      }
      
      match /incorrect-answers/{answerId} {
         allow read, write, delete: if isOwner(userId) || isServer();
      }
    }

    match /game-sets/{gameSetId} {
      allow read: if isSignedIn();
      // Allow creating new sets, or updating if you are the creator or server
      allow create: if isSignedIn();
      allow update: if isServer() || (isSignedIn() && resource.data.creatorId == request.auth.uid);
      allow delete: if isServer() || (isSignedIn() && resource.data.creatorId == request.auth.uid);
    }

    match /game-rooms/{roomId} {
      // Any signed-in user can create a room.
      // Any signed-in user can read a room to join.
      // Only players in the room or the server can update it.
      allow read, create: if isSignedIn();
      allow update: if isServer() || (isSignedIn() && request.auth.uid in resource.data.players);
    }
  }
}
