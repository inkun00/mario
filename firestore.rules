rules_version = '2';

service cloud.firestore {
  match /databases/{database}/documents {

    // Users can only read their own profile, but anyone can create a new user profile during signup.
    // Writing (updating) is restricted to the user themselves.
    match /users/{userId} {
      allow read: if request.auth != null;
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && request.auth.uid == userId;
    }

    // Subcollections for user-specific data
    match /users/{userId}/{collection}/{docId} {
      allow read, write: if request.auth != null && request.auth.uid == userId;
    }

    // Game-sets can be read by anyone if public. Private sets can only be read by the creator.
    // Writing/deleting is restricted to the creator. Anyone can create a new set.
    match /game-sets/{gameSetId} {
      allow read: if resource.data.isPublic == true || (request.auth != null && request.auth.uid == resource.data.creatorId);
      allow create: if request.auth != null;
      allow update, delete: if request.auth != null && request.auth.uid == resource.data.creatorId;
    }

    // Game-rooms can be read and written to by any authenticated user.
    // This allows for joining, playing, and updating game state.
    match /game-rooms/{roomId} {
      allow read, write: if request.auth != null;
    }
  }
}
